<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NEM Sorgu Paneli</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background: #0f0f23; color: #f8fafc; min-height: 100vh; padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { display:flex; justify-content:space-between; align-items:center; padding:20px 0; border-bottom:1px solid rgba(255,255,255,0.06); margin-bottom:24px; }
    .logo-text { font-size:24px; font-weight:800; color:#8b5cf6; }
    .nav-actions { display:flex; gap:12px; }
    .btn { padding:10px 18px; border-radius:10px; border:none; font-weight:600; font-size:14px; cursor:pointer; text-decoration:none; display:inline-flex; align-items:center; gap:8px; }
    .btn-primary { background:#8b5cf6; color:white; }
    .btn-secondary { background:rgba(255,255,255,0.06); color:white; }
    .card { background:#1a1b2f; border-radius:16px; padding:24px; margin-bottom:20px; border:1px solid rgba(255,255,255,0.06); }
    .card-title { font-size:20px; font-weight:700; color:white; margin-bottom:8px; }
    .input-field { padding:12px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.03); color:white; font-size:15px; }
    .submit-btn { padding:12px; background:#8b5cf6; color:white; border:none; border-radius:10px; font-size:15px; font-weight:700; cursor:pointer; display:inline-flex; gap:8px; align-items:center; }
    .results-title { font-size:18px; font-weight:700; color:white; margin-bottom:12px; }
    .loading { display:flex; flex-direction:column; align-items:center; gap:12px; padding:24px; color:#cbd5e1; }
    .loading-spinner { width:36px; height:36px; border:3px solid rgba(139,92,246,0.25); border-top:3px solid #8b5cf6; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .person-card { background:rgba(255,255,255,0.03); border-radius:12px; padding:16px; margin-bottom:12px; border:1px solid rgba(255,255,255,0.04); }
    .person-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; }
    .person-name { font-size:16px; font-weight:800; color:#a78bfa; }
    .person-tc { font-size:13px; color:#cbd5e1; background:rgba(139,92,246,0.12); padding:6px 10px; border-radius:8px; }
    .person-details { display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:10px; }
    .detail-label { font-size:12px; color:#cbd5e1; font-weight:700; }
    .detail-value { font-size:14px; color:white; word-break:break-word; }
    .error-message { background:rgba(239,68,68,0.06); border:1px solid rgba(239,68,68,0.18); color:#fca5a5; padding:14px; border-radius:10px; text-align:center; }
    .success-message { background:rgba(16,185,129,0.06); border:1px solid rgba(16,185,129,0.18); color:#6ee7b7; padding:14px; border-radius:10px; text-align:center; }
    .raw-toggle { margin-top:8px; text-align:right; }
    pre.json { background:rgba(0,0,0,0.45); padding:12px; border-radius:8px; overflow:auto; color:#d1d5db; max-height:300px; }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="logo"><div class="logo-text">NEM Sorgu</div></div>
      <div class="nav-actions">
        <a href="/panel" class="btn btn-secondary"><i class="fas fa-arrow-left"></i>Panele Dön</a>
        <a href="/" class="btn btn-primary"><i class="fas fa-home"></i>Ana Sayfa</a>
      </div>
    </header>

    <main>
      <section class="card">
        <div class="card-title" id="form-title">Ad Soyad Sorgulama</div>
        <p class="card-subtitle" style="color:#cbd5e1;margin-bottom:12px;">Güvenli ve hızlı sorgulama için bilgileri girin</p>

        <form id="queryForm" class="form-row" autocomplete="off">
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <div style="flex:1; min-width:160px;">
              <label class="detail-label">Ad</label>
              <input type="text" id="ad" name="ad" class="input-field" placeholder="Ad girin..." required>
            </div>
            <div style="flex:1; min-width:160px;">
              <label class="detail-label">Soyad</label>
              <input type="text" id="soyad" name="soyad" class="input-field" placeholder="Soyad girin..." required>
            </div>
            <div style="align-self:flex-end;">
              <button type="submit" class="submit-btn"><i class="fas fa-search"></i> Sorguyu Başlat</button>
            </div>
          </div>
        </form>
      </section>

      <section class="card">
        <div class="results-title">Sorgu Sonuçları</div>
        <div id="result">
          <div class="loading" id="default-state">
            <div class="loading-spinner"></div>
            <p>Sorgu sonuçları burada görünecek</p>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // Basit HTML kaçışı (XSS öncesi basit koruma)
    function escapeHTML(s) {
      if (s === null || s === undefined) return '';
      return String(s)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    // Farklı olası alan isimlerini algılama
    function pickName(person) {
      const keys = Object.keys(person || {});
      const nameKeys = ['ADI','adi','ad','Ad','isim','name','Name'];
      for (const k of nameKeys) if (k in person && person[k]) return String(person[k]);
      // fallback: ilk string alan
      for (const k of keys) {
        const v = person[k];
        if (typeof v === 'string' && v.trim().length>0) return v;
      }
      return '-';
    }
    function pickSurname(person) {
      const surnameKeys = ['SOYADI','soyadi','soyad','Soyad','surname','Surname'];
      for (const k of surnameKeys) if (k in person && person[k]) return String(person[k]);
      return '-';
    }
    function pickTC(person) {
      const tcKeys = ['TC','tc','tckimlik','tckimlikno','tc_no','tcno'];
      for (const k of tcKeys) if (k in person && person[k]) return String(person[k]);
      return '-';
    }

    // Helper: verilen objenin içinden muhtemel array'i döndür (ör. {data: [...]}, {result: [...]})
    function extractPossibleItems(obj) {
      if (!obj) return null;
      if (Array.isArray(obj)) return obj;
      // yaygın alan isimleri
      const candidates = ['data','result','results','items','rows','persons','kisiler'];
      for (const c of candidates) {
        if (c in obj && Array.isArray(obj[c])) return obj[c];
      }
      // eğer obj'un içinde numeric indexli keys varsa (0,1,2...)
      const numericKeys = Object.keys(obj).filter(k => /^[0-9]+$/.test(k));
      if (numericKeys.length) {
        // sırala ve maple
        numericKeys.sort((a,b)=>Number(a)-Number(b));
        return numericKeys.map(k => obj[k]);
      }
      return null;
    }

    // DOM oluşturucu ile güvenli HTML üretimi
    function renderPersonCardSafe(person, index) {
      const container = document.createElement('div');
      container.className = 'person-card';

      const header = document.createElement('div');
      header.className = 'person-header';

      const nameDiv = document.createElement('div');
      nameDiv.className = 'person-name';
      nameDiv.textContent = `Sonuç ${index} - ${pickName(person)} ${pickSurname(person)}`;

      const tcDiv = document.createElement('div');
      tcDiv.className = 'person-tc';
      tcDiv.textContent = pickTC(person);

      header.appendChild(nameDiv);
      header.appendChild(tcDiv);
      container.appendChild(header);

      const details = document.createElement('div');
      details.className = 'person-details';

      // Eğer person bir primitive ise göster
      if (typeof person !== 'object' || person === null) {
        const d = document.createElement('div');
        d.className = 'detail-item';
        d.innerHTML = `<div class="detail-label">Değer</div><div class="detail-value">${escapeHTML(String(person))}</div>`;
        details.appendChild(d);
      } else {
        // Tüm alanları alfabetik sırayla göster (objeler JSON olarak)
        const keys = Object.keys(person).sort();
        if (keys.length === 0) {
          const d = document.createElement('div');
          d.className = 'detail-item';
          d.innerHTML = `<div class="detail-label">Bilgi</div><div class="detail-value">(alan yok)</div>`;
          details.appendChild(d);
        } else {
          for (const k of keys) {
            const val = person[k];
            // boş/null/undefined atla
            if (val === null || val === undefined || val === '') continue;

            const item = document.createElement('div');
            item.className = 'detail-item';
            const label = document.createElement('div');
            label.className = 'detail-label';
            label.textContent = k;
            const value = document.createElement('div');
            value.className = 'detail-value';
            // eğer nested obje/array ise prettify JSON
            if (typeof val === 'object') {
              const pre = document.createElement('pre');
              pre.className = 'json';
              try {
                pre.textContent = JSON.stringify(val, null, 2);
              } catch (e) {
                pre.textContent = String(val);
              }
              value.appendChild(pre);
            } else {
              value.textContent = String(val);
            }
            item.appendChild(label);
            item.appendChild(value);
            details.appendChild(item);
          }
        }
      }

      container.appendChild(details);
      return container;
    }

    // DOM'a yazan ana fonksiyon
    function displayResults(data) {
      const resultDiv = document.getElementById('result');

      if (!data) {
        resultDiv.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-triangle"></i><h3>Hata</h3><p>API'den yanıt alınamadı</p></div>`;
        return;
      }
      if (!data.success) {
        resultDiv.innerHTML = `<div class="error-message"><i class="fas fa-exclamation-triangle"></i><h3>Sorgu Başarısız</h3><p>${escapeHTML(data.error || 'Bilinmeyen hata')}</p></div>`;
        return;
      }

      // data.data beklenen
      let results = data.data;

      // Eğer server doğrudan iç içe bir nesne döndüyse, olası array'i çıkar
      const possible = extractPossibleItems(results);
      if (possible) results = possible;

      // Eğer hala tek bir object ise ve içinde list yoksa onu array'e alabiliriz (tek kişi)
      if (!Array.isArray(results)) {
        // eğer object içerisindeki alanlar bir kişiye benziyorsa tekil göster
        if (typeof results === 'object' && results !== null && Object.keys(results).length > 0) {
          results = [results];
        } else if (typeof results === 'string') {
          resultDiv.innerHTML = `<div class="success-message"><i class="fas fa-check-circle"></i><h3>API Yanıtı</h3><p>${escapeHTML(results)}</p></div>`;
          addRawToggle(resultDiv, data);
          return;
        } else {
          resultDiv.innerHTML = `<div class="success-message"><i class="fas fa-check-circle"></i><h3>Sorgu Tamamlandı</h3><p>Sonuç bulunamadı.</p></div>`;
          addRawToggle(resultDiv, data);
          return;
        }
      }

      // Şimdi results bir array olmalı
      if (Array.isArray(results) && results.length === 0) {
        resultDiv.innerHTML = `<div class="success-message"><i class="fas fa-check-circle"></i><h3>Sorgu Tamamlandı</h3><p>Sonuç bulunamadı.</p></div>`;
        addRawToggle(resultDiv, data);
        return;
      }

      // Temizle ve render et
      resultDiv.innerHTML = '';
      const frag = document.createDocumentFragment();

      if (Array.isArray(results)) {
        results.forEach((item, idx) => {
          const card = renderPersonCardSafe(item, idx + 1);
          frag.appendChild(card);
        });
      }

      resultDiv.appendChild(frag);
      addRawToggle(resultDiv, data);
    }

    function addRawToggle(container, data) {
      const togg = document.createElement('div');
      togg.className = 'raw-toggle';
      const btn = document.createElement('button');
      btn.className = 'btn btn-secondary';
      btn.style.padding = '6px 10px';
      btn.style.fontSize = '13px';
      btn.textContent = 'Ham JSON Göster/Gizle';
      togg.appendChild(btn);
      const pre = document.createElement('pre');
      pre.className = 'json';
      pre.style.display = 'none';
      try {
        pre.textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        pre.textContent = String(data);
      }
      btn.addEventListener('click', () => {
        pre.style.display = pre.style.display === 'none' ? 'block' : 'none';
      });
      container.appendChild(togg);
      container.appendChild(pre);
    }

    // --- form submit ---
    const urlParams = new URLSearchParams(window.location.search);
    const apiName = urlParams.get('api') || 'Ad Soyad Sorgulama';
    document.getElementById('form-title').textContent = `${apiName} Sorgusu`;

    const form = document.getElementById('queryForm');
    const defaultState = document.getElementById('default-state');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const ad = document.getElementById('ad').value.trim();
      const soyad = document.getElementById('soyad').value.trim();
      if (!ad || !soyad) { alert('Lütfen ad ve soyad girin!'); return; }

      defaultState.style.display = 'none';
      document.getElementById('result').innerHTML = `<div class="loading"><div class="loading-spinner"></div><p>Sorgu yapılıyor...</p></div>`;

      const requestData = { api: apiName, ad: ad, soyad: soyad };
      console.log('Gönderilen veri:', requestData);

      try {
        const response = await fetch('/api/sorgu', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(requestData),
          credentials: 'include'
        });

        const result = await response.json();
        console.log('API Yanıtı:', result);
        displayResults(result);
      } catch (err) {
        console.error('Sorgu hatası:', err);
        document.getElementById('result').innerHTML = `<div class="error-message"><i class="fas fa-exclamation-triangle"></i><h3>Sorgu Hatası</h3><p>API bağlantı hatası: ${escapeHTML(err && err.message ? err.message : String(err))}</p></div>`;
      }
    });

    // autofocus
    document.addEventListener('DOMContentLoaded', () => {
      const firstInput = document.getElementById('ad');
      if (firstInput) firstInput.focus();
    });
  </script>
</body>
  </html>
